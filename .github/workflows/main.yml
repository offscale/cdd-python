name: Linting, testing, and coverage

on: [push]

jobs:
    build:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: [3.8]

        steps:
            -   uses: actions/checkout@v2
            -   name: Set up Python ${{ matrix.python-version }}
                uses: actions/setup-python@v2
                with:
                    python-version: ${{ matrix.python-version }}
            -   name: Configure git
                run: |
                    email_author="$(git log -1 --pretty=format:'%an <%ce>')"
                    author="${email_author% *}"
                    email="${email_author#*<}"; email="${email::-1}"
                    git config --global user.name "$author"
                    git config --global user.email "$email"
            -   name: Install dependencies
                run: |
                    python -m pip install --upgrade pip
                    python -m pip install --upgrade setuptools wheel
                    pip install flake8
                    pip install -r requirements.txt
            -   name: Lint with flake8
                run: |
                    # stop the build if there are Python syntax errors or undefined names
                    flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
                    # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
                    flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
            -   name: Test with unittest
                run: |
                    python setup.py test
            -   name: Doc coverage
                run: |
                    pip install interrogate
                    interrogate --generate-badge '.github/doccoverage.svg'
                    sed -i 's/interrogate/doc coverage/g' .github/doccoverage.svg
                    if git diff --name-only --diff-filter='M' | grep -qF '.github/doccoverage.svg'; then
                        git add .github/doccoverage.svg
                        git commit -m '[.github/doccoverage.svg] Updated coverage'
                    fi
            - name: Test coverage
              uses: codecov/codecov-action@v1
              with:
                  token: ${{ secrets.CODECOV_TOKEN }} # not required for public repos
            - name: Push changes
              run: |
                  if [ ! -z "$(git cherry -v origin/master)" ]; then git push origin master; fi
